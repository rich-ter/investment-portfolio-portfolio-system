<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking Portal</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>Απαλλακτική Εργασία Νεφουπολογιστικής</h1>
        <div class="user-section">
        <span class="user-name">User: <span id="userName">John Doe</span></span>
        <button id="logoutButton">Logout</button>
        </div>
    </header>
    <main>
        <div class="top-section">
            <section class="form-section">
                <h2>Investment Portfolio Rev Request</h2>
                <form id="portfolioRequestForm">
                    <input type="text" id="title" placeholder="Title" required>
                    <input type="date" id="date" required>
                    <textarea id="description" placeholder="Description" required></textarea>
                    <button type="submit">Submit</button>
                </form>
            </section>
            <section class="cro-info">
                <img src="cro-placeholder.jpg" alt="CRO Image" class="cro-image">
                <p class="cro-name">CRO Name</p>
            </section>
        </div>
        <section class="applications">
            <h2>Your Applications</h2>
            <div class="application" id="applicationsContainer">
                <!-- Submitted applications will be shown here -->
            </div>
        </section>
        <section class="responses">
            <h2>Responses</h2>
            <div class="response" id="responsesContainer">
                <!-- Responses will be shown here -->
            </div>
        </section>
    </main>
    <!-- <script src="script.js"></script> -->

    <script type="module">
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDs3lVnUrQNwENZVucKekgKrD8Ar7LIp7k",
            authDomain: "kiriazis-420f5.firebaseapp.com",
            projectId: "kiriazis-420f5",
            storageBucket: "kiriazis-420f5.appspot.com",
            messagingSenderId: "890131473043",
            appId: "1:890131473043:web:12c264c0f993015977a366"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore();


        function initializeUserDependentFeatures() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Fetch and display the user's name
                    getDoc(doc(db, "users", user.uid)).then((docSnap) => {
                        if (docSnap.exists()) {
                            const userData = docSnap.data();
                            document.getElementById('userName').textContent = userData.name || 'John Doe';
                        } else {
                            console.log("No user document found");
                        }
                    });

                    // Fetch and display submitted forms
                    displaySubmittedForms(user);

                } else {
                    console.log("No user is signed in.");
                    // Redirect to login page or handle accordingly
                }
            });
        }


    // Adjusted function to display submitted forms, now requires a user parameter
    async function displaySubmittedForms(user) {
        try {
            const formsQuery = query(collection(db, "test"), where("userID", "==", user.uid));
            const querySnapshot = await getDocs(formsQuery);
            const applicationsContainer = document.getElementById('applicationsContainer');
            applicationsContainer.innerHTML = '';
            querySnapshot.forEach(doc => {
                const formData = doc.data();
                const formHTML = `
            <div>
                <h3>${formData.title}</h3>
                <p>Date: ${formData.date}</p>
                <p>Description: ${formData.description}</p>
            </div>
        `;
                applicationsContainer.innerHTML += formHTML;
            });
        } catch (error) {
            console.error("Error fetching submitted forms:", error);
        }
    }


    initializeUserDependentFeatures();

    // Call the function to display submitted forms when the page loads
    // window.addEventListener('load', displaySubmittedForms);

    document.getElementById('portfolioRequestForm').addEventListener('submit', async e => {
        e.preventDefault();

        const currentUser = auth.currentUser;
        const titleInput = document.getElementById('title');
        const dateInput = document.getElementById('date');
        const descriptionInput = document.getElementById('description');

        // Check if the input elements exist and have non-empty values
        const title = titleInput.value.trim();
        const date = dateInput.value.trim();
        const description = descriptionInput.value.trim();

        if (!title || !date || !description) {
            console.error("One or more form fields are empty.");
            return; // Exit the function if any field is empty
        }

        try {
            // Add the document to Firestore
            const docRef = await addDoc(collection(db, "test"), {
                userID: currentUser.uid,
                title: title,
                date: date,
                description: description,
            });

            console.log("Document written with ID: ", docRef.id);

            // Add the application to the "Your Applications" section
            const applicationsContainer = document.getElementById('applicationsContainer');
            applicationsContainer.innerHTML += `<div><h3>${title}</h3><p>${date}</p><p>${description}</p></div>`;

            // Clear the form fields after submission
            document.getElementById('portfolioRequestForm').reset();
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    });

    const logoutButton = document.getElementById('logoutButton');
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log('User signed out successfully');
                window.location.href = 'login_page.html'; // Redirect to login page
            }).catch((error) => {
                console.error('Sign out error', error);
            });
        });
    </script>
</body>

</html>